<!--ts-->

<div align = "center"><font size = 4>队列</font></div>

* [一、什么是队列](#一什么是队列)
* [二、如何实现队列](#二如何实现队列)
   * [1）两种实现方式](#1两种实现方式)
   * [2）实现关键](#2实现关键)
* [三、队列变种及其应用](#三队列变种及其应用)
   * [1）阻塞队列](#1阻塞队列)
   * [2）并发队列](#2并发队列)
   * [3）应用](#3应用)



#### 一、什么是队列

---

**队列：**先进先出，一个操作受限的线性表。头部删除数据、尾部插入数据。

包含循环队列、阻塞队列、并发队列。

**用途：**高性能队列 Disruptor、Linux 环形缓存，都用到了循环并发队列。 java concurrent 并发包利用 ArrayBlockingQueue 实现公平锁。



#### 二、如何实现队列

---

##### 1）两种实现方式

数组 or 链表。分别称为为顺序队列和链式队列。

**Note**： 实现时，head 指向第一个有效数据。  tail 指向最后一个有效数据的下一个无效数据。来数据时，

直接 queue[tail] = data.然后 tail++。



##### 2）实现关键

确定好队列空和队列满的判定条件。下面分为循环队列和普通队列的队满和队空的条件。

| 队列     | 空条件                | 满条件                          | 备注                                        |
| -------- | --------------------- | ------------------------------- | ------------------------------------------- |
| 普通队列 | head == tail 头尾重合 | head = 0 && tail = n (数组大小) | tail == n 时需要搬移数据，平均复杂度 $O(1)$ |
| 循环队列 | head == tail 头尾重合 | (tail + 1) % n == head          | tail 指向的空间不存储数据                   |



#### 三、队列变种及其应用

---

##### 1）阻塞队列

其实就是在队列基础上增加了阻塞操作。入队和出队都可以阻塞。简单来说，就是在队列为空的时候，从队头取数据会被阻塞（阻塞指的是，阻塞获取数据对应的线程，然后让其挂起，之后来了数据的时候在唤醒它，让它获取数据即可）。因为此时还没有数据可取，直到队列中有了数据才能返回；如果队列已经满了，那么插入数据的操作就会被阻塞（与上同理），直到队列中有空闲位置后再插入数据，然后再返回。



典型应用：「生产者和消费者模型」，一个线程生产数据放入阻塞队列，其他线程（可以是多个）从阻塞队列中获取数据。



##### 2）并发队列

保证入队和出队时线程安全的队列。最直接的方式就是在入队列和出队列前后加锁/解锁。但是这样的后果是锁粒度太大，导致的并发度太低。基于数组的循环队列，利用 CAS 原子操作，可以实现非常高效的并发队列。<font color=green>具体原理待定查看！</font>。这也是基于数组的循环队列比链式队列应用更加广泛的原因。

**Note**：利用循环队列实现并发队列时，需要对并发数据有一定的预测，否则会丢失太多的请求。



##### 3）应用

 线程池没有空闲线程时，新的任务请求线程资源时，线程池该如何处理？各种处理策略又是如何实现的呢？

> 有两种解决方式：
>
> - 非阻塞方式：直接拒绝掉任务请求。
>
> - 阻塞方式：将任务进行排队，即压入队列中，等到有空闲线程时，取出排队的头部任务，处理该任务。
>
> 基于阻塞方式的策略（先进先出）有两种实现：
>
> - 基于链表实现方式：**一个无界队列**。但是可能会导致过多的请求排队等待，请求处理的响应时间过长。所以，针对响应时间比较敏感的系统，基于链表实现的无限排队的线程池是不合适的。
>
> - 基于数组的实现方式：**有界队列**。队列的大小有限，所以线程池中排队的请求超过队列大小时，接下来的请求就会被拒绝，这种方式对响应时间敏感的系统来说，就相对更加合理。不过，设置一个合理的队列大小，也是非常有讲究的。队列太大导致等待的请求太多，队列太小会导致无法充分利用系统资源、发挥最大性能。

总结：实际上，对于大部分资源有限的场景，当没有空闲资源时，基本上都可以通过「队列」数据结构，来实现请求排队。

<!--te-->